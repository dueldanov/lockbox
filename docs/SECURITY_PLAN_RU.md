# План исправления безопасности LockBox

## Обзор

Данный документ описывает план исправления уязвимостей, обнаруженных в ходе security code review проекта LockBox. План разделён на две фазы: DEV (функциональность) и PROD (безопасность).

---

## Фаза 1: DEV — Рабочий функционал

**Цель:** Система запускается, данные корректно сохраняются и читаются, базовый flow работает.

### 1.1 Критические баги (блокируют работу системы)

| ID | Файл | Строки | Проблема | Решение |
|----|------|--------|----------|---------|
| **D1** | `internal/crypto/hkdf.go` | 55-56 | masterKey не копируется в структуру — всегда нули | Добавить `copy(h.masterKey, masterKey)` после создания слайса |
| **D2** | `internal/service/service.go` | 365-369 | `deserializeShard()` возвращает пустой шард | Реализовать парсинг формата, соответствующего `serializeShard()` |
| **D3** | `internal/service/service.go` | 381-389 | `getOwnershipProof()` игнорирует прочитанные данные | Реализовать десериализацию proof из storage |
| **D4** | `internal/service/service.go` | 58-62 | Master key генерируется при каждом запуске и теряется | Временно: сохранять в файл/переменную окружения |

### 1.2 Функциональные заглушки

| ID | Файл | Строки | Проблема | Решение |
|----|------|--------|----------|---------|
| **D5** | `internal/lockscript/vm.go` | 306-309 | `verifySignature()` — заглушка, принимает любую подпись | Реализовать Ed25519 верификацию |
| **D6** | `internal/crypto/zkp.go` | 353-384 | XOR вместо криптографического хеша в commitments | Заменить на `crypto/sha256` (временно, до MiMC) |

### 1.3 Порядок исправлений

```
D1 → D4 → D2 → D3 → D5 → D6

D1: HKDF генерирует реальные ключи (не нули)
 ↓
D4: Ключ сохраняется между перезапусками
 ↓
D2: Шарды корректно десериализуются
 ↓
D3: Ownership proofs читаются из storage
 ↓
D5: LockScript авторизация работает
 ↓
D6: ZKP commitments криптографически корректны
```

---

## Фаза 2: PROD — Безопасность и защита

**Цель:** Защита от атак, готовность к production-окружению.

### 2.1 Криптография

| ID | Файл | Строки | Проблема | Решение |
|----|------|--------|----------|---------|
| **P1** | `internal/crypto/encrypt.go` | 287-293 | XOR checksum — тривиальные коллизии | Заменить на HMAC-SHA256 с ключом из HKDF |
| **P2** | `internal/crypto/encrypt.go` | 296-307 | Timing attack через early return | Использовать `crypto/subtle.ConstantTimeCompare()` |
| **P3** | `internal/crypto/zkp.go` | 353-384 | SHA256 не snark-friendly | Заменить на Poseidon или MiMC hash |
| **P4** | `internal/crypto/encrypt.go` | 29-33 | Слабые параметры Argon2 | Увеличить: Time=3, Memory=64MB+, адаптивный выбор |
| **P5** | `internal/crypto/hkdf.go` | 72-73 | Ключи возвращаются в sync.Pool без очистки | Добавить `clearBytes()` перед `Put()` |

### 2.2 Управление ключами (KMS)

| ID | Проблема | Решение |
|----|----------|---------|
| **P6** | Master key хранится в файле | Интеграция с HashiCorp Vault / AWS KMS / GCP KMS |
| **P7** | Salt генерируется случайно и не сохраняется | Персистировать salt вместе с зашифрованными данными |
| **P8** | Отсутствует ротация ключей | Реализовать API для key rotation с re-encryption |

### 2.3 Защита от DoS

| ID | Файл | Строки | Проблема | Решение |
|----|------|--------|----------|---------|
| **P9** | `internal/crypto/memory.go` | 64-73 | Бесконечное создание буферов при исчерпании пула | Добавить максимальный лимит в `Get()` |
| **P10** | `internal/service/grpc_server.go` | 99-106 | Нет лимита на количество MultiSigAddresses | Валидация: `len(addresses) ≤ 10` |
| **P11** | `internal/middleware/ratelimit.go` | 43-49 | Все анонимные запросы под одним лимитом | IP-based rate limiting |
| **P12** | `internal/crypto/encrypt.go` | 120 | Integer overflow при `shardID + index` | Использовать safe math или uint64 |

### 2.4 Инфраструктура

| ID | Файл/Область | Проблема | Решение |
|----|--------------|----------|---------|
| **P13** | `grpc_server.go` | TLS выключен по умолчанию | TLS обязателен, warning при отключении |
| **P14** | `service.go:226` | `fmt.Printf` для логирования | Structured logging (zap/zerolog) |
| **P15** | `internal/verification/` | Использование `math/rand` | Заменить на `crypto/rand` |
| **P16** | Audit logging | Нет защиты целостности логов | Hash chain для audit записей |

---

## Матрица приоритетов

| Приоритет | DEV | PROD |
|-----------|-----|------|
| **Критический** | D1, D2, D3, D4 | P1, P2, P6 |
| **Высокий** | D5, D6 | P3, P4, P5, P7, P8 |
| **Средний** | — | P9, P10, P11, P12 |
| **Низкий** | — | P13, P14, P15, P16 |

---

## Критерии готовности

### DEV Ready
- [ ] Все тесты проходят
- [ ] Данные сохраняются и читаются корректно
- [ ] LockScript выполняется с реальной верификацией
- [ ] ZKP proofs генерируются и верифицируются

### PROD Ready
- [ ] Все криптографические примитивы заменены на production-grade
- [ ] KMS интегрирован
- [ ] Rate limiting настроен
- [ ] TLS обязателен
- [ ] Penetration testing пройден
- [ ] Security audit завершён
